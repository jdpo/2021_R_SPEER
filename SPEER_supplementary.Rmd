---
title: 'Supplementary information'
output:
  word_document: default
  html_document: default
  pdf_document: default
---

```{r Initial formatting, include=FALSE}
knitr::opts_chunk$set(echo=FALSE)

load("./models_fitted_new.RData")

summary$ID_time <- as.numeric(summary$ID_time)
summary$run <-as.factor(summary$run)
summary$tunnel <-as.factor(summary$tunnel)
summary$ID <- as.factor(summary$ID)
summary$FR <- summary$front_true/(summary$front_false+summary$front_true)
summary$ID_press <- paste(summary$ID, summary$npress, sep ="_")


library(nlme)
library(MuMIn)
library(tidyverse)
library(flextable)
library(ggplot2)
library(ggh4x)
devtools::install_github("thomasp85/scico")
library(scico)


```
```{r Tab 1, include = FALSE}
biomass_summary <- biomasses %>% 
  rename(start = "Biomass at start (g)",
         end = "Biomass at end (g)") %>% 
  mutate(diff = start - end,
         fat = 0.675 * diff) %>% 
  left_join((swimtime %>% select(ID, time_d, distance)), by = c("ID_old" = "ID")) %>% 
  filter(ID != "g") %>% 
  mutate(fat_km = fat/distance,
         fat_6000 = fat_km*6000)
  

align(flextable(biomasses %>%
            left_join((swimtime %>% select(ID, time_d, distance)), by = c("ID_old" = "ID")) %>% 
            select("ID", "Length (cm)", "Silvering Index*", "Biomass at start (g)", "Biomass at end (g)", "Fat at start (% WM)", "Fat at end (% WM)", "Silvering Index*", "time_d", "distance") %>%
            mutate(time_d = round(time_d, 1),
                   distance = round(distance, 0)) %>% 
            rename("Swim time (d)" = time_d,
                   "Swimming distance (km)" = distance)) %>% 
  colformat_num(big.mark   = "") %>%
  autofit(add_w = -0.5), align = "center", part = "all")
```
```{r Tab 2, include = FALSE}

intervals <- intervals(lme.final)
intervals <- data.frame(intervals$fixed)
intervals <- intervals %>%
            rename(Lower_confidence_limit = lower,
                   Upper_confidence_limit = upper)
result <- as.data.frame(coef(summary(lme.final)))
result$p <- result$'p-value'
result$Parameter <- rownames(result)
intervals$rownames <- rownames(intervals)


flextable(result %>%
  mutate(p = ifelse(p <= 0.001, "<0.001" , round(p, 3))) %>%
  left_join(intervals, by = c("Parameter" = "rownames")) %>%
  mutate("Lower conf. limit" = round(Lower_confidence_limit, 3),
         "Upper conf. limit" = round(Upper_confidence_limit, 3),
         Value = round(Value, 3)) %>%
  select(c('Parameter', 'Value', 'Lower conf. limit', 'Upper conf. limit', 'p')) %>% 
  mutate(Parameter = if_else(Parameter == "(Intercept)", "Intercept", 
                             if_else(Parameter == "temp_mean", "Temperature",
                             if_else(Parameter == "press_mean", "Pressure",
                             if_else(Parameter == "speedBL", "Flow rate",
                             if_else(Parameter == "temp_mean", "Temperature",
                             if_else(Parameter == "tunnel2", "Tunnel 2",
                             if_else(Parameter == "tunnel3", "Tunnel 3",
                             if_else(Parameter == "run2", "Run 2", "Run 3")))))))))) %>%
  autofit() 
 

```
```{r Fig 1, dpi = 300, include = FALSE}

fig1 <- tag_facet2(
  ggplot(summary, aes(x=ID_time, y=resp)) +
  geom_point(aes(col = temp_mean, shape = as.factor(npress)), size=0.7) +
  theme_bw()+
  theme(text = element_text(size = 8, family = "sans")) +
  scale_shape_manual(values = c(1, 16))+
  scale_colour_scico(palette = "batlow", name = "temp (°C)")+
  geom_line(aes(x= ID_time, y=exp(predict(lme.final, level = 0))), size = 0.4)+
  geom_line(aes(x= ID_time, y=exp(predict(lme.final)), group = ID), linetype = "dashed", size = 0.4)+
  labs(x = expression(time~(h)), y = expression(O[2]-consumption ~(mg/kg %*% h^-1)))+
  facet_grid(run ~ tunnel, labeller = labeller(tunnel = tunnel.names, run = run.names))+
  guides(shape=FALSE),
  open ="", close ="", hjust = -1.2) 

fig1
```
```{r Fig 2, dpi = 300, include = FALSE}


ideal_summary <- ideal %>%
  mutate(group = paste(temp_mean, press_mean, sep = "_")) %>% 
  group_by(group) %>% 
  summarize(mean = mean(resp),
            sd = sd(resp))

fig2 <- ggplot(ideal, aes(x=temp_mean, y=resp)) +
 theme_bw()+
  theme(text = element_text(size = 8, family = "sans")) +
  #geom_point(data = summary, aes(x=temp_mean, y = resp, shape = as.factor(npress)), size = 0.9, color = "grey75")+
  #scale_shape_manual(values = c(1, 16))+
  geom_smooth(aes(linetype = as.factor(press_mean)), se = F, color = "black", method = "loess", formula = y~x, size = 0.8)+
  labs(linetype = "pressure (bar)", x = "temp (°C)", y = expression(O[2]-consumption ~(mg/kg %*% h^-1)))+
  theme(legend.position = c(.05, .95),
        legend.justification = c("left", "top"),
        legend.margin = margin(6, 6, 6, 6),
        legend.box.background = element_rect(color="black", size=1))+
  guides(shape=FALSE)

fig2

```
**Supplementary background respiration**
/
Background respiration was measured prior and after each run at 19°C (in mg l-1 h-1), corresponding to a total background respiration between 4.4 – 8.7 mg h-1 (mean per tunnel). Subsequently, background respiration for all other temperatures was calculated based on an estimated Q10 of 1.83, which was derived from additional measurements at different temperatures after the swimming trials. For each individual measurement, the background respiration was calculated and substracted from the observed total respiration. 

**Supplementary model selection**
/
Log transformation was used since data was positive only and right skewed, while residuals showed a multiplicative error structure. A general linear mixed-model (lme) with log-transformed response was preferred to generalized linear mixed-models (GLMMs), e.g. gamma or inverse-gaussian with a log-link (lme4::glmer, Bates et al. 2015 since the use of nlme::lme (Pinheiro et al. 2020) enabled the implementation of a first order autoregressive autocorrelation structure (with time in hours as continuous co-variate) to account for temporal autocorrelation. However, either method produced generally the same results (not shown).
Random effects structure and fixed parameters were then selected following Zuur et al. (2009). First, a model with a single random intercept (to account for non-independence of measurements within individuals) was compared to a second model including an additional random slope for flow rate to also account for individually different responses to changes in flow rate (with some eels actively increasing the flow rate while actually “resting” in the front of the tunnel, see above). 
The second model, being the more parsimonious, was subsequently used in stepwise backwards regression; yet, removal of parameters did not significantly improve model performance (based on AIC & Log-likelihood, Tab S2), thus the initial fixed effects structure was kept.
/
/
**Tab S1** Summary of swimming time per combination of temperature and pressure by individual.

```{r, warning = FALSE, echo = FALSE}
flextable(biomasses %>%
            select(ID, ID_old) %>% 
            left_join(treattime, by = c("ID_old" = "ID")) %>%
            mutate(ntemp = replace(ntemp, ntemp == "15", 15.5)) %>% 
            select(-ID_old, -start, -end, -time_h) %>%
              mutate(time_d = round(time_d, 1)) %>% 
            rename("nominal pressure" = npress,
                   "nominal temperature" = ntemp,
                   "Swimming time (d)" = time_d)) %>% 
          colformat_num(big.mark   = "") %>%
  autofit()

```

**Tab S2** Summary of parameters describing the goodness of fit of the statistical models in consideration.

```{r Tab S1, warning = FALSE, echo = FALSE}

round_df <- function(x, digits) {
    # round all numeric variables
    # x: data frame 
    # digits: number of digits to round
    numeric_columns <- sapply(x, mode) == 'numeric'
    x[numeric_columns] <-  round(x[numeric_columns], digits)
    x
}




AIC_scores <- flextable(select.lme %>%
         mutate_if(is.numeric, round, 2)) %>%   
  autofit()

FitFlextableToPage <- function(ft, pgwidth = 6){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}

FitFlextableToPage(AIC_scores)
 
```

\
\
\
\

```{r Fig S1, dpi = 300, warning = FALSE, echo = FALSE}

ggplot(summary, aes(x=speedBL, y=resp)) +
    geom_point(size=0.2)+ 
    theme_bw()+
    theme(text = element_text(size = 8, family = "sans")) +
    xlim(0.4, 0.8)+
    facet_nested(ntemp + npress ~ Letter_ID )+
  labs(linetype = "pressure (bar)", x = "flow rate (body length/s)", y = expression(O[2]-consumption ~(mg/kg %*% h^-1)))+
  theme(axis.text.x = element_text(angle = 45, size = 6))+
  theme(axis.text.y = element_text(size = 8))+
  geom_smooth(method='lm', formula= y~x, se = F, size = 0.7)
```

**Fig S1** Effect of swimming speed on Oxygen consumption rate per Temperature and pressure for each individual
